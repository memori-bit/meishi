# Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™é …ç›®ã¾ã¨ã‚

## ğŸš¨ ç¾çŠ¶ï¼šæº–å‚™ãŒå®Œäº†ã—ã¦ã„ãªã„é …ç›®

### âœ… å®Œäº†ï¼šCloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ

**ç¾çŠ¶**: Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆæ¸ˆã¿

**å®Œäº†ã—ãŸä½œæ¥­:**
- âœ… Cloud SQL Admin APIã‚’æœ‰åŠ¹åŒ–
- âœ… Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ `meishi-db` ãŒå­˜åœ¨ï¼ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³: `us-central1`ï¼‰
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ `meishi` ã‚’ä½œæˆ
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ `meishi_user` ã‚’ä½œæˆ

**æ³¨æ„**: 
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯`us-central1`ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ã‚Šã¾ã™ï¼ˆCloud Runã¯`asia-northeast1`ï¼‰
- ç•°ãªã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é–“ã®æ¥ç¶šã¯å¯èƒ½ã§ã™ãŒã€è‹¥å¹²ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™

### âœ… å®Œäº†ï¼šDATABASE_URLã®Secret Managerç™»éŒ²

**ç¾çŠ¶**: `database-url` SecretãŒç™»éŒ²æ¸ˆã¿

**å®Œäº†ã—ãŸä½œæ¥­:**
- âœ… æ¥ç¶šæ–‡å­—åˆ—ã‚’Secret Managerã«ç™»éŒ²
- âœ… Secretå: `database-url`

### âŒ å¿…é ˆï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œï¼ˆæœªå®Œäº†ï¼‰

**ç¾çŠ¶**: ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœªä½œæˆ

**å¿…è¦ãªä½œæ¥­:**

1. **Cloud SQL Proxyã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**
   - [Cloud SQL Proxy ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://cloud.google.com/sql/docs/postgres/connect-instance-cloud-sql-proxy)
   - èªè¨¼æƒ…å ±ã‚’è¨­å®š

2. **Cloud SQL Proxyã‚’èµ·å‹•**
   ```bash
   ./cloud-sql-proxy bizcard-ocr-prod:asia-northeast1:meishi-db
   ```

3. **DATABASE_URLã‚’è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ¥ç¶šï¼‰**
   ```bash
   export DATABASE_URL="postgresql://meishi_user:YOUR_PASSWORD@127.0.0.1:5432/meishi"
   ```

4. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ**
   ```bash
   npx prisma migrate deploy
   ```

### âš ï¸ æ¨å¥¨ï¼šãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ã®ä¿®æ­£ï¼ˆæœªå®Œäº†ï¼‰

**ç¾çŠ¶**: Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

**å¿…è¦ãªä½œæ¥­:**

1. **node_modulesã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```

2. **Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†ç”Ÿæˆ**
   ```bash
   npx prisma generate
   ```

3. **ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª**
   ```bash
   npm run build
   ```

## âœ… å®Œäº†æ¸ˆã¿ã®é …ç›®

1. âœ… Secret Managerã¸ã®APIã‚­ãƒ¼ç™»éŒ²
   - `google-search-api-key`
   - `google-search-engine-id`
   - `nextauth-secret`
   - `google-service-account-key`
   - `openai-api-key` â† **æ–°è¦ç™»éŒ²å®Œäº†**

2. âœ… IAMæ¨©é™è¨­å®š
   - Secret Manager Secret Accessoræ¨©é™

3. âœ… Artifact Registryãƒªãƒã‚¸ãƒˆãƒª
   - `meishiocr` ãƒªãƒã‚¸ãƒˆãƒªä½œæˆæ¸ˆã¿

4. âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
   - `scripts/deploy-with-cloud-build.sh` ä½œæˆæ¸ˆã¿
   - `OPENAI_API_KEY`ã®Secretå‚ç…§è¨­å®šæ¸ˆã¿

## ğŸ“‹ æº–å‚™å®Œäº†å¾Œã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

ã™ã¹ã¦ã®æº–å‚™ãŒå®Œäº†ã—ãŸã‚‰ï¼š

```bash
cd /Users/nakazatokeita/meishi
export PATH="$HOME/google-cloud-sdk/bin:$PATH"
./scripts/deploy-with-cloud-build.sh
```

## ğŸ’¡ æº–å‚™ã®å„ªå…ˆé †ä½

1. **æœ€å„ªå…ˆ**: Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
2. **æœ€å„ªå…ˆ**: DATABASE_URLã®Secret Managerç™»éŒ²
3. **å¿…é ˆ**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
4. **æ¨å¥¨**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ã®ä¿®æ­£
5. âœ… **å®Œäº†**: OPENAI_API_KEYã®ç™»éŒ²

## â±ï¸ æ‰€è¦æ™‚é–“ã®ç›®å®‰

- Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ: 10-15åˆ†
- DATABASE_URLç™»éŒ²: 5åˆ†
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 10åˆ†
- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ä¿®æ­£: 10åˆ†
- **åˆè¨ˆ**: ç´„35-40åˆ†

## ğŸ” æº–å‚™çŠ¶æ³ã®ç¢ºèªã‚³ãƒãƒ³ãƒ‰

```bash
# Secret Managerã®ç¢ºèª
gcloud secrets list --project=bizcard-ocr-prod

# Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç¢ºèª
gcloud sql instances list --project=bizcard-ocr-prod

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ã®ç¢ºèª
npm run build
```
